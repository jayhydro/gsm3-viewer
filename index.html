<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GSM3 â€” Global Soil Moisture Viewer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0d12;--pn:#111520;--inp:#0d1017;--bd:#1e2636;--t1:#dfe4ed;--t2:#8690a4;--t3:#4d576b;--ac:#3b82f6;--acd:rgba(59,130,246,.15);--gn:#22c55e;--am:#f59e0b;--f:'Instrument Sans',system-ui,sans-serif;--m:'DM Mono',monospace;--r:8px}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;font-family:var(--f);background:var(--bg);color:var(--t1);overflow:hidden}
.shell{display:grid;grid-template-columns:310px 1fr;height:100vh}
.side{background:var(--pn);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow-y:auto;z-index:900}
.side::-webkit-scrollbar{width:4px}.side::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
.brand{padding:22px 18px 16px;border-bottom:1px solid var(--bd)}
.brand h1{font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--am),var(--ac))}
.brand h1 span{color:var(--t3);font-weight:400}
.brand p{font-size:11px;color:var(--t3);font-family:var(--m);margin-top:4px;line-height:1.5}
.sec{padding:14px 18px;border-bottom:1px solid var(--bd)}
.sec-t{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);font-family:var(--m);font-weight:500;margin-bottom:8px}
.inp{width:100%;background:var(--inp);border:1px solid var(--bd);color:var(--t1);padding:8px 10px;border-radius:var(--r);font-family:var(--m);font-size:12px;outline:none;transition:border-color .15s}
.inp:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--acd)}
.inp::-webkit-calendar-picker-indicator{filter:invert(.6);cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:8px 12px;border:none;border-radius:var(--r);cursor:pointer;font-family:var(--f);font-weight:600;font-size:12px;transition:all .15s;white-space:nowrap}
.btn-go{background:var(--ac);color:#fff}.btn-go:hover{background:#2563eb}.btn-go:disabled{opacity:.4;cursor:not-allowed}
.btn-s{background:var(--inp);color:var(--t2);border:1px solid var(--bd);padding:5px 8px;font-size:10px}.btn-s:hover{color:var(--t1)}.btn-s.on{border-color:var(--ac);color:var(--ac);background:var(--acd)}
.row{display:flex;gap:5px}
.nav{display:flex;gap:3px;margin-top:8px}.nav .btn-s{flex:1;text-align:center}
.anim{display:flex;gap:5px;align-items:center}
.splbl{font-family:var(--m);font-size:10px;color:var(--t3);margin-left:auto}
.sr{display:flex;align-items:center;gap:8px;margin-top:4px}
input[type=range]{-webkit-appearance:none;flex:1;height:3px;background:var(--bd);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--ac);cursor:pointer;border:2px solid var(--pn)}
.sv{font-family:var(--m);font-size:10px;color:var(--t2);min-width:28px;text-align:right}
.lgbar{height:8px;border-radius:4px;margin-bottom:4px;background:linear-gradient(90deg,#7c2d12,#b45309,#d97706,#f59e0b,#fbbf24,#a3e635,#4ade80,#22d3ee,#0ea5e9,#0284c7,#1e40af)}
.lglbl{display:flex;justify-content:space-between;font-family:var(--m);font-size:9px;color:var(--t3)}
.lgnote{font-size:9px;color:var(--t3);font-family:var(--m);margin-top:5px;font-style:italic}
.st{padding:10px 18px;border-top:1px solid var(--bd);margin-top:auto}
.st-r{display:flex;align-items:center;gap:7px;font-family:var(--m);font-size:10px;color:var(--t3)}
.sd{width:6px;height:6px;border-radius:50%;background:var(--t3);flex-shrink:0}
.sd.ok{background:var(--gn)}.sd.ld{background:var(--am);animation:pu .8s infinite}.sd.er{background:#ef4444}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.3}}
.mw{position:relative;overflow:hidden}
#map{width:100%;height:100%;background:var(--bg)}
.badge{position:absolute;top:14px;left:14px;z-index:800;background:rgba(17,21,32,.92);backdrop-filter:blur(10px);border:1px solid var(--bd);border-radius:var(--r);padding:8px 14px;display:none;flex-direction:column;gap:1px}
.badge.on{display:flex}
.badge .b1{font-family:var(--m);font-size:14px;font-weight:500}
.badge .b2{font-family:var(--m);font-size:9px;color:var(--t3)}
.ldr{position:absolute;inset:0;background:rgba(10,13,18,.8);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:700}
.ldr.on{display:flex}
.sp{width:32px;height:32px;border:3px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.lt{font-family:var(--m);font-size:11px;color:var(--t2)}
.tip{position:absolute;bottom:16px;right:16px;z-index:800;background:rgba(17,21,32,.92);backdrop-filter:blur(10px);border:1px solid var(--bd);border-radius:var(--r);padding:8px 12px;pointer-events:none;opacity:0;transition:opacity .15s;font-family:var(--m);font-size:10px;color:var(--t2)}
.tip.on{opacity:1}
.leaflet-control-zoom a{background:var(--pn)!important;color:var(--t1)!important;border-color:var(--bd)!important}
.leaflet-control-zoom a:hover{background:var(--inp)!important}
.leaflet-control-attribution{background:rgba(10,13,18,.7)!important;color:var(--t3)!important;font-size:9px!important}
.leaflet-control-attribution a{color:var(--t2)!important}
@media(max-width:768px){.shell{grid-template-columns:1fr;grid-template-rows:auto 1fr}.side{max-height:40vh;border-right:none;border-bottom:1px solid var(--bd)}}
</style>
</head>
<body>
<div class="shell">
<aside class="side">
  <div class="brand">
    <h1><span class="dot"></span>GSM3 <span>Viewer</span></h1>
    <p>Global Soil Moisture &middot; Multitask Model<br>Daily, 9 km, 2015&ndash;2020</p>
  </div>

  <div class="sec">
    <div class="sec-t">Select Date</div>
    <div class="row">
      <input type="date" class="inp" id="di" min="2015-01-01" max="2020-12-31" value="2018-07-15">
      <button class="btn btn-go" id="gb" onclick="go()">Load</button>
    </div>
    <div class="nav">
      <button class="btn btn-s" onclick="mv(-30)">&laquo; Month</button>
      <button class="btn btn-s" onclick="mv(-1)">&lsaquo; Day</button>
      <button class="btn btn-s" onclick="mv(1)">Day &rsaquo;</button>
      <button class="btn btn-s" onclick="mv(30)">Month &raquo;</button>
    </div>
  </div>

  <div class="sec">
    <div class="sec-t">Animation</div>
    <div class="anim">
      <button class="btn btn-s" id="ab" onclick="ta()">&#9654; Play</button>
      <button class="btn btn-s" onclick="ss(2000,this)">Slow</button>
      <button class="btn btn-s on" onclick="ss(800,this)">Med</button>
      <button class="btn btn-s" onclick="ss(300,this)">Fast</button>
      <span class="splbl" id="sl">800ms</span>
    </div>
  </div>

  <div class="sec">
    <div class="sec-t">Opacity</div>
    <div class="sr">
      <input type="range" id="os" min="0" max="100" value="100" oninput="so(this.value)">
      <span class="sv" id="ov">100%</span>
    </div>
  </div>

  <div class="sec">
    <div class="sec-t">Soil Moisture (m&sup3;/m&sup3;)</div>
    <div class="lgbar"></div>
    <div class="lglbl"><span>0.00 Dry</span><span>0.30</span><span>0.60 Wet</span></div>
    <div class="lgnote">Color range clipped to 0&ndash;0.6 for visual contrast</div>
  </div>

  <div class="sec">
    <div class="sec-t">Data &amp; Citation</div>
    <div style="font-size:10px;color:var(--t3);font-family:var(--m);line-height:1.6">
      <b>Download:</b><br>
      <a href="https://doi.org/10.5281/zenodo.7026036" target="_blank" style="color:var(--ac);text-decoration:none">doi.org/10.5281/zenodo.7026036</a>
    </div>
    <div style="font-size:9px;color:var(--t3);font-family:var(--m);line-height:1.5;margin-top:8px;padding:8px;background:var(--inp);border-radius:6px;border:1px solid var(--bd)">
      Liu, J., et al. (2023). Evaluating a global soil moisture dataset from a multitask model (GSM3 v1.0) with potential applications for crop threats. <i>Geoscientific Model Development</i>, 16(5), 1553&ndash;1567.
    </div>
  </div>

  <div class="sec">
    <div class="sec-t">Keyboard Shortcuts</div>
    <div style="font-size:10px;color:var(--t3);font-family:var(--m);line-height:1.7">
      <b>&larr; &rarr;</b> &nbsp;Previous / next day<br>
      <b>Space</b> &nbsp;Play / pause<br>
      <b>Enter</b> &nbsp;Load selected date
    </div>
  </div>

  <div class="st">
    <div class="st-r"><div class="sd" id="sD"></div><span id="sT">Select a date to begin</span></div>
  </div>
</aside>

<div class="mw">
  <div id="map"></div>
  <div class="badge" id="bdg"><span class="b1" id="b1"></span><span class="b2" id="b2"></span></div>
  <div class="tip" id="tip"><div id="tc"></div></div>
</div>
</div>

<script>
const BASE='https://huggingface.co/datasets/HFLLL/gsm3-visualization/resolve/main';
const PREFIX='GSM3_';
const BND=[[-85.045,-180],[85.045,180]];

let ly=null,at=null,aspd=800,ia=false;
const pc={};

const map=L.map('map',{
  crs: L.CRS.EPSG4326,
  center:[20,0],
  zoom:1,
  minZoom:0,
  maxZoom:6,
  maxBounds:[[-90,-200],[90,200]],
  attributionControl:true
});
map.attributionControl.addAttribution('<a href="https://zenodo.org/records/7344484">GSM3 Dataset</a>');

const $=id=>document.getElementById(id);
function st(s,m){$('sD').className='sd '+(({ok:'ok',ld:'ld',er:'er'})[s]||'');$('sT').textContent=m}
function fd(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function ym(d){return`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`}

function burl(d){
  const fn=`${PREFIX}${ym(d)}.png`;
  return{url:`${BASE}/${d.getFullYear()}/${fn}`,fn};
}

function go(td){
  const d=td||new Date($('di').value+'T00:00:00');
  if(isNaN(d.getTime())){st('er','Invalid date');return}
  const u=burl(d);
  st('ld',u.fn);$('gb').disabled=true;
  const img=new Image();
  img.onload=()=>{
    if(ly)map.removeLayer(ly);
    ly=L.imageOverlay(u.url,BND,{opacity:parseInt($('os').value)/100}).addTo(map);
    $('bdg').classList.add('on');$('b1').textContent=fd(d);$('b2').textContent=u.fn;
    $('di').value=fd(d);st('ok','Loaded '+fd(d));$('gb').disabled=false;
    // Preload nearby dates
    for(const o of[-2,-1,1,2]){const nd=new Date(d);nd.setDate(nd.getDate()+o);const nu=burl(nd);if(!pc[nu.url]){const i=new Image();i.onload=()=>{pc[nu.url]=1};i.src=nu.url}}
  };
  img.onerror=()=>{st('er','Not found: '+u.fn);$('gb').disabled=false};
  img.src=u.url;
}

function mv(n){const d=new Date($('di').value+'T00:00:00');if(isNaN(d.getTime()))return;d.setDate(d.getDate()+n);if(d<new Date('2015-01-01')||d>new Date('2020-12-31'))return;$('di').value=fd(d);go(d)}
function ta(){if(ia){ia=false;clearTimeout(at);$('ab').innerHTML='&#9654; Play';$('ab').classList.remove('on')}else{ia=true;$('ab').innerHTML='&#9646;&#9646; Pause';$('ab').classList.add('on');tk()}}
function tk(){if(!ia)return;mv(1);at=setTimeout(tk,aspd)}
function ss(ms,el){aspd=ms;$('sl').textContent=ms+'ms';document.querySelectorAll('.anim .btn-s:not(#ab)').forEach(b=>b.classList.remove('on'));if(el)el.classList.add('on')}
function so(v){$('ov').textContent=v+'%';if(ly)ly.setOpacity(v/100)}

map.on('mousemove',e=>{$('tc').textContent=`${e.latlng.lat.toFixed(2)}\u00b0N, ${e.latlng.lng.toFixed(2)}\u00b0E`;$('tip').classList.add('on')});
map.on('mouseout',()=>$('tip').classList.remove('on'));

$('di').addEventListener('keydown',e=>{if(e.key==='Enter')go()});
document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT')return;if(e.key==='ArrowRight')mv(1);if(e.key==='ArrowLeft')mv(-1);if(e.key===' '){e.preventDefault();ta()}});

(()=>{const p=new URLSearchParams(location.search);if(p.get('date'))$('di').value=p.get('date');go()})();
</script>
</body>
</html>
